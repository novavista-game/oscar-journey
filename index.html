<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Oscar's Cosmic Odyssey: Stage Retry Fix</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw; font-family: 'Arial', sans-serif; touch-action: none; }
        
        #game-container { position: relative; width: 100vw; height: 56.25vw; max-width: 177.78vh; max-height: 100vh; background: #000; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; background: #111; border: 2px solid #ffd700; box-sizing: border-box; }

        /* [Î™®Î∞îÏùº Ï°∞Ï¢Ö Î≤ÑÌäº] */
        #mobileControls { position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; z-index: 10000; display: none; }
        .touch-btn { 
            position: absolute; pointer-events: auto; 
            width: 13vh; height: 13vh; min-width: 75px; min-height: 75px;
            background: rgba(255, 215, 0, 0.45); border: 3px solid #ffd700; 
            border-radius: 50%; color: #fff; display: flex; justify-content: center; align-items: center; font-size: 5vh; font-weight: bold;
            user-select: none; -webkit-tap-highlight-color: transparent; box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }
        #btn-up { left: 5%; bottom: 42%; }
        #btn-down { left: 5%; bottom: 8%; }
        #btn-fire { 
            right: 5%; bottom: 10%; width: 18vh; height: 18vh; min-width: 110px; min-height: 110px;
            background: rgba(0, 242, 255, 0.45); border-color: #00f2ff; font-size: 3.5vh; box-shadow: 0 0 25px rgba(0, 242, 255, 0.7);
        }

        /* [ÏãúÏûë ÌôîÎ©¥ ÎîîÏûêÏù∏] */
        #startScreen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: url('bg.jpg') no-repeat center/cover;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 50000; 
        }
        #startScreen::before { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: -1; }
        
        #scoreGuide { 
            display: flex; gap: 2vw; background: rgba(0,0,0,0.4); padding: 2vh 4vh; border-radius: 20px; 
            margin: 2vh 0; border: 2px solid #ffd700; backdrop-filter: blur(8px);
        }
        .guide-item { text-align: center; color: white; font-size: 1.8vh; padding: 0 2vw; border-right: 1px solid rgba(255,255,255,0.2); }
        .guide-item:last-child { border-right: none; }
        .guide-item span { display: block; font-weight: bold; color: #ffd700; font-size: 2.2vh; }

        #startBtn { 
            padding: 2vh 10vh; font-size: 4vh; cursor: pointer; background: #ffd700; 
            border: none; font-weight: bold; border-radius: 60px; color: #000; margin-top: 2vh;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        /* UI Î†àÏù¥Ïñ¥ Î∞è Ïò§Î≤ÑÎ†àÏù¥ Î©îÏãúÏßÄ */
        #ui { position: absolute; top: 3%; color: white; text-align: center; width: 100%; z-index: 20000; pointer-events: none; display: none; text-shadow: 2px 2px 4px #000; }
        .overlay-msg { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            display: none; text-align: center; z-index: 80000; 
            background: rgba(0,0,0,0.95); padding: 5vh; border-radius: 25px; border: 4px solid #ffd700; 
            width: 60%; color: white; box-shadow: 0 0 50px rgba(0,0,0,1);
        }
        .overlay-msg h2 { font-size: 5vh; margin-bottom: 2vh; }
        .retry-btn { padding: 1.5vh 6vh; font-size: 3vh; background: #ffd700; border: none; font-weight: bold; border-radius: 50px; cursor: pointer; color: #000; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="mobileControls">
        <div id="btn-up" class="touch-btn">‚ñ≤</div>
        <div id="btn-down" class="touch-btn">‚ñº</div>
        <div id="btn-fire" class="touch-btn">FIRE</div>
    </div>

    <div id="startScreen">
        <h1 style="color: #ffd700; font-size: 8vh; margin: 0;">The Odyssey of Mt. Sumeru</h1>
        <p style="color: #fff; font-size: 2.2vh; margin-top: 1vh; font-weight: bold;">PC: Arrows & Space | Smartphone: Touch Buttons</p>
        
        <div id="scoreGuide">
            <div class="guide-item">üì¶<span>10 pts</span>Box</div>
            <div class="guide-item">üçú‚òïüç™<span>100 pts</span>Bonus</div>
            <div class="guide-item">üçñüçóüç∫<span>500 pts</span>Super</div>
        </div>
        
        <button id="startBtn">ENTER GAME</button>
    </div>

    <div id="ui">
        <h2 id="stageTitle" style="margin: 0; color: #ffd700; font-size: 4vh;">Stage 1</h2>
        <div style="font-size: 2.8vh;">Score: <span id="score">0</span> / <span id="target">1000</span> | Lives: <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
    </div>

    <div id="failMsg" class="overlay-msg">
        <h2 style="color: #ff4444;">MISSION FAILED</h2>
        <p style="font-size: 2.5vh; margin-bottom: 3vh;">Don't give up, Oscar!</p>
        <button class="retry-btn" onclick="initStage(currentStage)">RETRY STAGE</button>
    </div>

    <div id="successMsg" class="overlay-msg">
        <h2 style="color: #ffd700;">MISSION SUCCESS!</h2>
        <button class="retry-btn" onclick="nextStage()">NEXT STAGE</button>
    </div>

    <div id="keywordMsg" class="overlay-msg">
        <h2 style="color: #ffd700;">PASSWORD</h2>
        <input type="text" id="keywordInput" style="padding: 10px; width: 70%; font-size: 20px; text-align: center; text-transform: uppercase; border-radius: 10px; border: none;">
        <br><button class="retry-btn" onclick="checkKeyword()" style="margin-top: 20px;">CONFIRM</button>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 1066; canvas.height = 600;

const bgm = new Audio('bgm.mp3'); bgm.loop = true;
const scoreSfx = new Audio('score.mp3');
const oscarImg = new Image(); oscarImg.src = 'oscar.png';
const bonusImg = new Image(); bonusImg.src = 'bonus.png';
const starbucksImg = new Image(); starbucksImg.src = 'starbucks.png';
const ramenImg = new Image(); ramenImg.src = 'ramen.png';
const meatImg = new Image(); meatImg.src = 'meat.png';
const chickenImg = new Image(); chickenImg.src = 'chicken.png';
const beerImg = new Image(); beerImg.src = 'beer.png';
const bgImg = new Image();

let gameState = 'START', currentStage = 1, score = 0, targetScore = 1000, lives = 3, invincibility = 0;
let bonusItems = [], bullets = [], keys = {};
const oscar = { x: 80, y: 235, w: 140, h: 140, speed: 10 };
const targets = [1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000];

function setupTouch(id, keyName) {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => {
        e.preventDefault(); keys[keyName] = true;
        if(keyName === 'Space' && gameState === 'PLAYING') fireBeam();
    }, {passive: false});
    el.addEventListener('touchend', (e) => { e.preventDefault(); keys[keyName] = false; }, {passive: false});
}
setupTouch('btn-up', 'ArrowUp'); setupTouch('btn-down', 'ArrowDown'); setupTouch('btn-fire', 'Space');

window.addEventListener('keydown', e => { if(e.code === 'Space' && gameState === 'PLAYING') fireBeam(); keys[e.code] = true; });
window.addEventListener('keyup', e => keys[e.code] = false);

document.getElementById('startBtn').addEventListener('click', () => {
    gameState = 'PLAYING';
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    document.getElementById('mobileControls').style.display = 'block';
    bgm.play().catch(()=>{});
    initStage(1);
});

function fireBeam() {
    bullets.push({ x: oscar.x + 120, y: oscar.y + 65, w: 50, h: 10, speed: 18 });
}

function initStage(num) {
    currentStage = num; score = 0; lives = 3; bonusItems = []; bullets = []; invincibility = 0;
    targetScore = targets[num-1];
    gameState = 'PLAYING';
    document.getElementById('stageTitle').innerText = (num === 10) ? "Infinity Stage" : `Stage ${num}`;
    document.querySelectorAll('.overlay-msg').forEach(m => m.style.display = 'none');
    bgImg.src = `stage${num}_bg.jpg`;
    updateUI();
}

function updateUI() {
    document.getElementById('score').innerText = score;
    document.getElementById('target').innerText = targetScore;
    document.getElementById('lives').innerText = "‚ù§Ô∏è".repeat(lives);
}

function checkKeyword() {
    const input = document.getElementById('keywordInput').value.toUpperCase();
    if (['OSCAR', 'COSMIC', 'ODYSSEY'].includes(input)) { initStage(5); } 
    else { alert("WRONG PASSWORD!"); }
}

function update() {
    if (gameState !== 'PLAYING') return;
    if (invincibility > 0) invincibility--;

    if (keys['ArrowUp']) oscar.y -= oscar.speed;
    if (keys['ArrowDown']) oscar.y += oscar.speed;
    oscar.y = Math.max(0, Math.min(canvas.height - oscar.h, oscar.y));

    bullets.forEach((b, i) => { b.x += b.speed; if(b.x > canvas.width) bullets.splice(i, 1); });

    // Ïû•Ïï†Î¨º ÏÉùÏÑ± (ÌÅ¨Í∏∞ 20% Ï∂ïÏÜå: 108px -> 86px)
    if (Math.random() < 0.02) {
        let rand = Math.random(), type = 'box';
        if (rand < 0.05) type = ['meat', 'chicken', 'beer'][Math.floor(Math.random()*3)];
        else if (rand < 0.25) type = ['starbucks', 'ramen'][Math.floor(Math.random()*2)];
        
        bonusItems.push({ 
            x: canvas.width, y: Math.random() * (canvas.height - 100), 
            size: 86, // ÏöîÏ≤≠ÌïòÏã† 20% Ï∂ïÏÜå Î∞òÏòÅ
            type: type, speed: 1.5 + (currentStage * 0.1) 
        });
    }

    for (let i = bonusItems.length - 1; i >= 0; i--) {
        let b = bonusItems[i]; b.x -= b.speed;

        // Îπî Ï∂©Îèå
        bullets.forEach((bull, j) => {
            if (bull.x < b.x + b.size && bull.x + bull.w > b.x && bull.y < b.y + b.size && bull.y + bull.h > b.y) {
                if (['meat', 'chicken', 'beer'].includes(b.type)) score += 500;
                else if (['starbucks', 'ramen'].includes(b.type)) score += 100;
                else score += 10;
                scoreSfx.currentTime = 0; scoreSfx.play().catch(()=>{});
                bonusItems.splice(i, 1); bullets.splice(j, 1);
                updateUI();
            }
        });

        // Ï∫êÎ¶≠ÌÑ∞ Ï∂©Îèå Î°úÏßÅ (ÌïòÌä∏ ÏÜåÏßÑ Ïãú Î©àÏ∂§ Î∞è Ïã§Ìå® ÌôîÎ©¥ ÎùÑÏö∞Í∏∞)
        if (bonusItems[i] && invincibility <= 0) {
            if (oscar.x + 35 < b.x + b.size - 30 && oscar.x + 105 > b.x + 30 && oscar.y + 30 < b.y + b.size - 25 && oscar.y + 110 > b.y + 25) {
                lives--; invincibility = 90;
                bonusItems.splice(i, 1);
                updateUI();
                if (lives <= 0) {
                    gameState = 'FAIL'; // Í≤åÏûÑ Ï§ëÎã®
                    document.getElementById('failMsg').style.display = 'block'; // Ïã§Ìå® ÌôîÎ©¥ ÎÖ∏Ï∂ú
                    return;
                }
            }
        }
        if (b && b.x + b.size < 0) bonusItems.splice(i, 1);
    }

    if (score >= targetScore) {
        if (currentStage === 4) {
            gameState = 'KEYWORD';
            document.getElementById('keywordMsg').style.display = 'block';
        } else {
            gameState = 'SUCCESS';
            document.getElementById('successMsg').style.display = 'block';
        }
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (bgImg.complete) ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
    bullets.forEach(b => { ctx.fillStyle = '#00f2ff'; ctx.shadowBlur = 10; ctx.shadowColor = '#00f2ff'; ctx.fillRect(b.x, b.y, b.w, b.h); ctx.shadowBlur = 0; });
    if (invincibility % 10 < 5) ctx.drawImage(oscarImg, oscar.x, oscar.y, oscar.w, oscar.h);
    bonusItems.forEach(b => {
        let img = bonusImg;
        if(b.type === 'starbucks') img = starbucksImg; else if(b.type === 'ramen') img = ramenImg; 
        else if(b.type === 'meat') img = meatImg; else if(b.type === 'chicken') img = chickenImg; 
        else if(b.type === 'beer') img = beerImg;
        ctx.drawImage(img, b.x, b.y, b.size, b.size);
    });
}

function nextStage() {
    if (currentStage >= 10) initStage(1);
    else initStage(currentStage + 1);
}
function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
gameLoop();
</script>
</body>
</html>