<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Odyssey of Mt. Sumeru - Smartphone Fix</title>
    <style>
        /* [CORE LAYOUT] */
        body { 
            margin: 0; 
            background: #000; 
            overflow: hidden; 
            width: 100vw; 
            height: 100vh; 
            touch-action: none; /* Prevent browser zooming/scrolling */
            font-family: 'Arial', sans-serif;
        }

        /* [MODIFIED for Smartphone Sizing Fix] */
        /* The game container is fixed to the design resolution (1066x600).
           We use JS to Scale this entire container to fit the screen. */
        #game-container { 
            position: absolute; 
            width: 1066px; 
            height: 600px; 
            background: #000; 
            overflow: hidden; 
            
            /* KEY FIX: Lock to center of screen */
            left: 50%;
            top: 50%;
            transform-origin: center center;
        }

        canvas { width: 100%; height: 100%; display: block; background: #111; border-top: 2px solid #ffd700; border-bottom: 2px solid #ffd700; box-sizing: border-box;}

        /* [ORIENTATION WARNING] */
        #orientation-lock {
            position: fixed; inset: 0; background: #000; z-index: 999999;
            display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        #orientation-lock h2 { color: #ffd700; margin-bottom: 20px; }
        #orientation-lock img { width: 64px; height: 64px; animation: rotatePhone 2s infinite; }
        @keyframes rotatePhone { 0% { transform: rotate(0deg); } 50% { transform: rotate(90deg); } 100% { transform: rotate(0deg); } }
        
        /* Show warning only on Portrait screens */
        @media screen and (orientation: portrait) {
            #orientation-lock { display: flex; }
        }

        /* [START SCREEN] */
        #startScreen { 
            position: absolute; inset: 0; 
            background: #111 url('bg.jpg') no-repeat center/cover; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 1000;
        }
        #startScreen::before { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: -1; }
        
        h1 { color: #ffd700; font-size: 60px; margin: 0 0 20px 0; text-shadow: 4px 4px 10px #000; text-align: center; }
        
        #scoreGuide { display: flex; gap: 30px; background: rgba(0,0,0,0.8); padding: 20px 40px; border-radius: 15px; border: 2px solid #ffd700; margin-bottom: 40px; }
        .guide-item { text-align: center; color: white; font-size: 18px; }
        .guide-item span { display: block; font-weight: bold; color: #ffd700; font-size: 24px; margin-bottom: 5px; }

        #startBtn { 
            padding: 20px 80px; font-size: 32px; cursor: pointer; background: #ffd700; 
            border: none; font-weight: bold; border-radius: 60px; color: #000; 
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* [TOUCH CONTROLS] */
        /* Hidden by default, shown via JS when game starts */
        #mobileControls { position: absolute; inset: 0; pointer-events: none; z-index: 2000; display: none; }
        .touch-btn { 
            position: absolute; pointer-events: auto; 
            width: 80px; height: 80px; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            border: 3px solid rgba(255,215,0,0.5); 
            background: rgba(255,215,0,0.1); 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 40px; 
            user-select: none;
        }
        .touch-btn:active { background: rgba(255,215,0,0.4); transform: scale(0.95); }
        
        #btn-up { left: 40px; bottom: 140px; }
        #btn-down { left: 40px; bottom: 40px; }
        #btn-fire { 
            right: 40px; bottom: 50px; width: 110px; height: 110px; 
            background: rgba(0, 242, 255, 0.2); border-color: #00f2ff; 
            font-size: 24px; font-weight: bold; color: #00f2ff;
        }

        /* [UI OVERLAYS] */
        #ui { position: absolute; top: 20px; width: 100%; text-align: center; color: #ffd700; font-size: 30px; z-index: 900; display: none; text-shadow: 2px 2px 5px #000; }
        .overlay-msg { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            text-align: center; background: rgba(0,0,0,0.95); padding: 40px; 
            border-radius: 30px; border: 4px solid #ffd700; color: white; 
            display: none; z-index: 3000; min-width: 500px;
        }
        .retry-btn { margin-top: 30px; padding: 15px 50px; background: #ffd700; border: none; font-weight: bold; border-radius: 50px; cursor: pointer; font-size: 24px; color: #000; }
        
        #stage-bar { 
            position: absolute; bottom: 20px; left: 20px; display: none; align-items: center; 
            background: rgba(10, 10, 30, 0.9); padding: 10px 20px; 
            border-radius: 50px; border: 2px solid #444466; z-index: 800; 
        }
        #stage-bar img { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; border: 2px solid #ffd700; }
        #stage-info-text { color: #8ecae6; font-size: 16px; font-weight: bold; }
    </style>
</head>
<body>

<div id="orientation-lock">
    <h2 style="font-size: 24px;">Please Rotate Device</h2>
    <div style="font-size: 40px;">‚ü≥</div>
    <p style="color: #aaa; margin-top:10px;">Landscape Mode Required</p>
</div>

<div id="game-container">
    <div id="ui"><span id="score">0</span> / <span id="target">1000</span> | <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>

    <div id="mobileControls">
        <div id="btn-up" class="touch-btn">‚ñ≤</div>
        <div id="btn-down" class="touch-btn">‚ñº</div>
        <div id="btn-fire" class="touch-btn">FIRE</div>
    </div>

    <div id="startScreen">
        <h1>The Odyssey of Mt. Sumeru</h1>
        <div id="scoreGuide">
            <div class="guide-item">üì¶<br><span>10 pts</span>Box</div>
            <div class="guide-item">üçúüç™<br><span>100 pts</span>Bonus</div>
            <div class="guide-item">üçñüç∫<br><span>500 pts</span>Super</div>
        </div>
        <button id="startBtn">ENTER GAME</button>
        
        <div style="position: absolute; bottom: 30px; left: 30px; display: flex; align-items: center; background: rgba(10, 10, 30, 0.9); padding: 10px 25px; border-radius: 50px; border: 2px solid #444466;">
            <img src="oscar.png" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; border: 2px solid #ffd700;">
            <span style="color: #8ecae6; font-size: 16px; font-weight: bold;">PROLOGUE: Login to Mt. Sumeru</span>
        </div>
    </div>

    <div id="stage-bar">
        <img src="oscar.png">
        <div id="stage-info-text">STAGE 01: Fragrant Ocean</div>
    </div>

    <div id="failMsg" class="overlay-msg">
        <h2 style="color: #ff4444; font-size: 50px; margin-bottom: 10px;">MISSION FAILED</h2>
        <p style="font-size: 20px; line-height: 1.5;">Oscar, steady your mind.<br>Focus on the present and try once more.</p>
        <button class="retry-btn" onclick="initStage(currentStage)">RETRY STAGE</button>
    </div>

    <div id="successMsg" class="overlay-msg">
        <h2 style="color: gold; font-size: 50px; margin-bottom: 10px;">MISSION SUCCESS!</h2>
        <p style="font-size: 20px;">Your mindfulness has brought you victory.</p>
        <button class="retry-btn" onclick="nextStage()">NEXT STAGE</button>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script>
/* --- [RESPONSIVE SCALING LOGIC - MODIFIED FOR SMARTPHONE] --- */
// This function forces the game to fit the screen exactly using Centering + Scale
function resizeGame() {
    const container = document.getElementById('game-container');
    const targetWidth = 1066;
    const targetHeight = 600;
    
    // Get current browser window dimensions
    const winWidth = window.innerWidth;
    const winHeight = window.innerHeight;

    // Calculate scale ratio
    const scale = Math.min(winWidth / targetWidth, winHeight / targetHeight);

    // KEY CHANGE: Apply scaling and centering with translate
    container.style.transform = `translate(-50%, -50%) scale(${scale})`;
    
    // Ensure CSS positioning is correct for centering
    container.style.left = '50%';
    container.style.top = '50%';
}

// Listen for resize and load events
window.addEventListener('resize', resizeGame);
window.addEventListener('load', resizeGame);
// Also call immediately
resizeGame();


/* --- [GAME ENGINE] --- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 1066; canvas.height = 600;

const bgm = new Audio('bgm.mp3'); bgm.loop = true;
const scoreSfx = new Audio('score.mp3');

const images = { oscar: new Image(), bg: new Image(), box: new Image(), ramen: new Image(), meat: new Image() };
images.oscar.src = 'oscar.png';
images.bg.src = 'stage1_bg.jpg';
images.box.src = 'bonus.png';
images.ramen.src = 'ramen.png';
images.meat.src = 'meat.png';

let gameState = 'START', currentStage = 1, score = 0, lives = 3, invincibility = 0;
let bullets = [], items = [], keys = {};
const targets = [1000, 2000, 3000, 4000, 5000];
const stageTitles = [
    "LVL 1: Fragrant Ocean - Dodge Waves of Illusion!",
    "STAGE 02: The Iron Gatekeeper - Defeat the Golem of Fixed Mindset!",
    "STAGE 03: Valley of Echoes - Listen to the Sound of Silence.",
    "STAGE 04: Peak of Clarity - Rise above the Clouds of Doubt.",
    "STAGE 05: The Golden Mandala - Realize your True Potential."
];

const oscar = { x: 80, y: 230, w: 140, h: 140, speed: 8 };

// --- [TOUCH & KEYBOARD INPUT] ---
function setupControl(id, keyName) {
    const el = document.getElementById(id);
    if(!el) return;
    
    const press = (e) => { 
        e.preventDefault(); 
        keys[keyName] = true; 
        // Visual feedback
        el.style.transform = "scale(0.9)";
        el.style.backgroundColor = "rgba(255,215,0,0.3)";
        if(keyName === 'Space' && gameState === 'PLAYING') fire(); 
    };
    
    const release = (e) => { 
        e.preventDefault(); 
        keys[keyName] = false; 
        el.style.transform = "scale(1)";
        el.style.backgroundColor = "rgba(255,215,0,0.1)";
        if(id === 'btn-fire') el.style.backgroundColor = "rgba(0, 242, 255, 0.2)";
    };

    el.addEventListener('touchstart', press, {passive: false});
    el.addEventListener('touchend', release, {passive: false});
    el.addEventListener('mousedown', press);
    el.addEventListener('mouseup', release);
    el.addEventListener('mouseleave', release);
}
setupControl('btn-up', 'ArrowUp'); 
setupControl('btn-down', 'ArrowDown'); 
setupControl('btn-fire', 'Space');

window.addEventListener('keydown', e => { keys[e.code] = true; if(e.code === 'Space' && gameState === 'PLAYING') fire(); });
window.addEventListener('keyup', e => keys[e.code] = false);

// --- [START LOGIC] ---
const startBtn = document.getElementById('startBtn');
startBtn.addEventListener('click', () => {
    gameState = 'PLAYING';
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    // Show Mobile Controls
    document.getElementById('mobileControls').style.display = 'block';
    document.getElementById('stage-bar').style.display = 'flex';
    
    // Attempt Audio
    try { bgm.play().catch(e => console.log("Audio play failed (interaction needed)", e)); } catch(e){}
    initStage(1);
    resizeGame(); // Force resize check on start
});

function fire() {
    bullets.push({ x: oscar.x + 110, y: oscar.y + 70, w: 40, h: 8, speed: 12 });
}

function initStage(num) {
    currentStage = num; score = 0; lives = 3; items = []; bullets = []; invincibility = 0;
    if(targets[num-1]) document.getElementById('target').innerText = targets[num-1];
    document.getElementById('stage-info-text').innerText = stageTitles[num-1] || `STAGE ${num}`;
    document.querySelectorAll('.overlay-msg').forEach(m => m.style.display = 'none');
    
    // Image loading safety
    const bgSrc = `stage${num}_bg.jpg`;
    images.bg.src = bgSrc; 
    
    updateUI();
}

function updateUI() {
    document.getElementById('score').innerText = score;
    document.getElementById('lives').innerText = "‚ù§Ô∏è".repeat(lives);
}

function update() {
    if (gameState !== 'PLAYING') return;
    if (invincibility > 0) invincibility--;

    if (keys['ArrowUp']) oscar.y -= oscar.speed;
    if (keys['ArrowDown']) oscar.y += oscar.speed;
    oscar.y = Math.max(0, Math.min(canvas.height - oscar.h, oscar.y));

    bullets.forEach((b, i) => { b.x += b.speed; if(b.x > canvas.width) bullets.splice(i, 1); });

    if (Math.random() < 0.015) { // Slightly increased spawn rate
        let type = Math.random() < 0.1 ? 'super' : (Math.random() < 0.3 ? 'bonus' : 'box');
        items.push({ x: canvas.width, y: Math.random() * (canvas.height - 100), size: 65, speed: 2 + (currentStage * 0.3), type: type });
    }

    for (let i = items.length - 1; i >= 0; i--) {
        let it = items[i]; it.x -= it.speed;
        
        // Bullet Collision
        bullets.forEach((bull, j) => {
            if (bull.x < it.x + it.size && bull.x + bull.w > it.x && bull.y < it.y + it.size && bull.y + bull.h > it.y) {
                score += (it.type === 'super' ? 500 : (it.type === 'bonus' ? 100 : 10));
                try { scoreSfx.currentTime = 0; scoreSfx.play().catch(()=>{}); } catch(e){}
                items.splice(i, 1); bullets.splice(j, 1);
                updateUI();
            }
        });

        // Player Collision
        if (items[i] && invincibility <= 0) {
            // Hitbox adjustment
            if (oscar.x + 40 < it.x + it.size - 30 && oscar.x + oscar.w - 40 > it.x + 30 && oscar.y + 40 < it.y + it.size - 30 && oscar.y + oscar.h - 40 > it.y + 30) {
                lives--; invincibility = 100; items.splice(i, 1); updateUI();
                if (lives <= 0) { gameState = 'FAIL'; document.getElementById('failMsg').style.display = 'block'; }
            }
        }
        if (it && it.x + it.size < 0) items.splice(i, 1);
    }
    if (score >= targets[currentStage-1]) { gameState = 'SUCCESS'; document.getElementById('successMsg').style.display = 'block'; }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (images.bg.complete) ctx.drawImage(images.bg, 0, 0, canvas.width, canvas.height);
    if (invincibility % 10 < 5) ctx.drawImage(images.oscar, oscar.x, oscar.y, oscar.w, oscar.h);
    bullets.forEach(b => { ctx.fillStyle = '#00f2ff'; ctx.fillRect(b.x, b.y, b.w, b.h); });
    items.forEach(it => {
        let img = images.box;
        if(it.type === 'bonus') img = images.ramen;
        if(it.type === 'super') img = images.meat;
        ctx.drawImage(img, it.x, it.y, it.size, it.size);
    });
}

function nextStage() { if (currentStage >= 5) currentStage = 0; initStage(currentStage + 1); }
function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
gameLoop();
</script>
</body>
</html>