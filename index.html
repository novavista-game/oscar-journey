<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>The Odyssey of Mt. Sumeru - Final Gold</title>
    <style>
        /* [CORE LAYOUT] */
        body { margin: 0; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'Arial', sans-serif; touch-action: none; }
        #game-container { position: relative; width: 100vw; height: 56.25vw; max-width: 177.78vh; max-height: 100vh; background: #000; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; background: #111; border-top: 2px solid #ffd700; border-bottom: 2px solid #ffd700; }

        /* [START SCREEN] */
        #startScreen { 
            position: absolute; inset: 0; 
            background: #111 url('bg.jpg') no-repeat center/cover; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 99999; 
        }
        #startScreen::before { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.4); z-index: -1; }
        
        h1 { color: #ffd700; font-size: 8vh; margin: 0; text-shadow: 2px 2px 15px #000; text-align: center; }
        
        #scoreGuide { display: flex; gap: 2vw; background: rgba(0,0,0,0.7); padding: 2vh 4vh; border-radius: 15px; border: 2px solid #ffd700; margin: 3vh 0; }
        .guide-item { text-align: center; color: white; font-size: 1.8vh; padding: 0 2vw; border-right: 1px solid #555; }
        .guide-item:last-child { border-right: none; }
        .guide-item span { display: block; font-weight: bold; color: #ffd700; font-size: 2.2vh; }

        #startBtn { 
            padding: 2.5vh 12vh; font-size: 4vh; cursor: pointer; background: #ffd700; 
            border: none; font-weight: bold; border-radius: 60px; color: #000; 
            box-shadow: 0 8px 15px rgba(255,215,0,0.3);
            pointer-events: auto;
        }

        /* [CONTROLS] */
        #mobileControls { position: absolute; inset: 0; pointer-events: none; z-index: 50; display: none; }
        .touch-btn { position: absolute; pointer-events: auto; width: 10vh; height: 10vh; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 2.5px solid #ffd700; background: rgba(255,215,0,0.15); color: white; font-size: 4vh; }
        
        /* UPDATED: Lifted buttons higher */
        #btn-up { left: 4vh; bottom: 30vh; } 
        #btn-down { left: 4vh; bottom: 12vh; }
        
        #btn-fire { right: 4vh; bottom: 8vh; width: 15vh; height: 15vh; background: rgba(0, 150, 150, 0.5); border-color: #00f2ff; font-size: 3vh; font-weight: bold; }

        /* [UI OVERLAYS] */
        #ui { position: absolute; top: 2vh; width: 100%; text-align: center; color: #ffd700; font-size: 3.5vh; z-index: 50; display: none; }
        .overlay-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0,0,0,0.95); padding: 5vh; border-radius: 30px; border: 4px solid #ffd700; color: white; display: none; z-index: 200; width: 60%; }
        
        #finalWinMsg { border-color: #00f2ff; background: rgba(0, 10, 30, 0.95); }
        
        .retry-btn { margin-top: 3vh; padding: 2vh 6vh; background: #ffd700; border: none; font-weight: bold; border-radius: 50px; cursor: pointer; font-size: 3vh; color: #000; }
        
        #stage-bar { position: absolute; bottom: 3vh; left: 3vh; display: none; align-items: center; background: rgba(10, 10, 30, 0.9); padding: 1vh 2.5vh; border-radius: 50px; border: 2px solid #444466; z-index: 60; }
        #stage-bar img { width: 5vh; height: 5vh; border-radius: 50%; margin-right: 1.5vh; border: 2px solid #ffd700; }
        #stage-info-text { color: #8ecae6; font-size: 1.8vh; font-weight: bold; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui"><span id="score">0</span> / <span id="target">1000</span> | <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>

    <div id="mobileControls">
        <div id="btn-up" class="touch-btn">‚ñ≤</div>
        <div id="btn-down" class="touch-btn">‚ñº</div>
        <div id="btn-fire" class="touch-btn">FIRE</div>
    </div>

    <div id="startScreen">
        <h1>The Odyssey of Mt. Sumeru</h1>
        <div id="scoreGuide">
            <div class="guide-item">üì¶<span>10 pts</span>Box</div>
            <div class="guide-item">üçúüç™<span>100 pts</span>Bonus</div>
            <div class="guide-item">üçñüç∫<span>500 pts</span>Super</div>
        </div>
        <button id="startBtn">ENTER GAME</button>
        <div style="position: absolute; bottom: 3vh; left: 3vh; display: flex; align-items: center; background: rgba(10, 10, 30, 0.9); padding: 1vh 2.5vh; border-radius: 50px; border: 2px solid #444466;">
            <img src="oscar.png" style="width: 5vh; height: 5vh; border-radius: 50%; margin-right: 1.5vh; border: 2px solid #ffd700;">
            <span style="color: #8ecae6; font-size: 1.8vh; font-weight: bold;">PROLOGUE: Login to Mt. Sumeru - The Golden Mandala</span>
        </div>
    </div>

    <div id="stage-bar">
        <img src="oscar.png">
        <div id="stage-info-text">STAGE 01: Fragrant Ocean - Dodge Waves of Illusion!</div>
    </div>

    <div id="failMsg" class="overlay-msg">
        <h2 style="color: #ff4444; font-size: 6vh; margin-bottom: 1vh;">MISSION FAILED</h2>
        <p style="font-size: 2.5vh; margin-bottom: 2vh;">Oscar, steady your mind.<br>Try once more.</p>
        <button class="retry-btn" onclick="initStage(currentStage)">RETRY STAGE</button>
    </div>

    <div id="successMsg" class="overlay-msg">
        <h2 style="color: gold; font-size: 6vh; margin-bottom: 1vh;">MISSION SUCCESS!</h2>
        <p style="font-size: 2.2vh;">Your mindfulness has brought you victory.</p>
        <button class="retry-btn" onclick="nextStage()">NEXT STAGE</button>
    </div>

    <div id="finalWinMsg" class="overlay-msg">
        <h2 style="color: #00f2ff; font-size: 6vh; margin-bottom: 1vh;">ALL MISSIONS COMPLETED!</h2>
        <p style="font-size: 3vh; color: #fff; margin-bottom: 2vh;">You are the Winner of the Day!</p>
        <p style="font-size: 2vh; color: #aaa; margin-bottom: 3vh;">You have conquered Mt. Sumeru.</p>
        <button class="retry-btn" style="background: #00f2ff;" onclick="restartGame()">PLAY AGAIN</button>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 1066; canvas.height = 600;

// Audio
const bgm = new Audio('bgm.mp3'); bgm.loop = true;
const scoreSfx = new Audio('score.mp3');

const images = { oscar: new Image(), bg: new Image(), box: new Image(), ramen: new Image(), meat: new Image() };
images.oscar.src = 'oscar.png';
images.bg.src = 'stage1_bg.jpg';
images.box.src = 'bonus.png';
images.ramen.src = 'ramen.png';
images.meat.src = 'meat.png';

let gameState = 'START', currentStage = 1, score = 0, lives = 3, invincibility = 0;
let bullets = [], items = [], keys = {};
const stageTitles = [
    "LVL 1: Fragrant Ocean",
    "STAGE 02: The Iron Gatekeeper",
    "STAGE 03: Valley of Echoes",
    "STAGE 04: Peak of Clarity",
    "STAGE 05: The Golden Mandala",
    "STAGE 06: Beyond the Clouds",
    "STAGE 07: Starry Path",
    "STAGE 08: Nebula Drift",
    "STAGE 09: Cosmic Void",
    "STAGE 10: Nirvana"
];

const oscar = { x: 80, y: 230, w: 140, h: 140, speed: 8 };

function setupControl(id, keyName) {
    const el = document.getElementById(id);
    if(!el) return;
    const press = (e) => { e.preventDefault(); keys[keyName] = true; if(keyName === 'Space' && gameState === 'PLAYING') fire(); };
    const release = (e) => { e.preventDefault(); keys[keyName] = false; };
    el.addEventListener('touchstart', press); el.addEventListener('touchend', release);
    el.addEventListener('mousedown', press); el.addEventListener('mouseup', release);
}
setupControl('btn-up', 'ArrowUp'); setupControl('btn-down', 'ArrowDown'); setupControl('btn-fire', 'Space');

window.addEventListener('keydown', e => { keys[e.code] = true; if(e.code === 'Space' && gameState === 'PLAYING') fire(); });
window.addEventListener('keyup', e => keys[e.code] = false);

// Start Button
const startBtn = document.getElementById('startBtn');
startBtn.addEventListener('click', startGameAction);

function startGameAction() {
    gameState = 'PLAYING';
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    document.getElementById('mobileControls').style.display = 'block';
    document.getElementById('stage-bar').style.display = 'flex';
    try { bgm.play().catch(() => console.warn("BGM blocked.")); } catch (e) {}
    initStage(1);
}

function fire() {
    bullets.push({ x: oscar.x + 110, y: oscar.y + 70, w: 40, h: 8, speed: 12 });
}

function initStage(num) {
    currentStage = num; score = 0; lives = 3; items = []; bullets = []; invincibility = 0;
    
    // --- STAGE 10 (VICTORY) LOGIC ---
    if (num === 10) {
        gameState = 'COMPLETE'; // Stop gameplay logic
        images.bg.src = `stage10_bg.jpg`; // Show Stage 10 Background
        
        // Hide Game UI
        document.getElementById('ui').style.display = 'none';
        document.getElementById('mobileControls').style.display = 'none';
        document.getElementById('stage-bar').style.display = 'none';
        
        // Show Victory Screen
        document.getElementById('finalWinMsg').style.display = 'block';
        return; // Stop initialization
    }

    // --- NORMAL STAGE LOGIC (1-9) ---
    gameState = 'PLAYING';
    
    const targetScore = num * 1000;
    document.getElementById('target').innerText = targetScore;
    
    const title = stageTitles[num-1] || `STAGE ${num}`;
    document.getElementById('stage-info-text').innerText = title;
    
    document.querySelectorAll('.overlay-msg').forEach(m => m.style.display = 'none');
    
    images.bg.src = `stage${num}_bg.jpg`;
    updateUI();
}

function updateUI() {
    document.getElementById('score').innerText = score;
    document.getElementById('lives').innerText = "‚ù§Ô∏è".repeat(lives);
}

function update() {
    if (gameState !== 'PLAYING') return;
    if (invincibility > 0) invincibility--;

    if (keys['ArrowUp']) oscar.y -= oscar.speed;
    if (keys['ArrowDown']) oscar.y += oscar.speed;
    oscar.y = Math.max(0, Math.min(canvas.height - oscar.h, oscar.y));

    bullets.forEach((b, i) => { b.x += b.speed; if(b.x > canvas.width) bullets.splice(i, 1); });

    if (Math.random() < 0.015) {
        let type = Math.random() < 0.1 ? 'super' : (Math.random() < 0.3 ? 'bonus' : 'box');
        
        // --- ELDERLY FRIENDLY SPEED ---
        // Reduced to start very slow (0.6) and increase gently (+0.07)
        let speed = 0.6 + (currentStage * 0.07); 
        
        items.push({ x: canvas.width, y: Math.random() * (canvas.height - 100), size: 65, speed: speed, type: type });
    }

    for (let i = items.length - 1; i >= 0; i--) {
        let it = items[i]; it.x -= it.speed;
        bullets.forEach((bull, j) => {
            if (bull.x < it.x + it.size && bull.x + bull.w > it.x && bull.y < it.y + it.size && bull.y + bull.h > it.y) {
                score += (it.type === 'super' ? 500 : (it.type === 'bonus' ? 100 : 10));
                try { scoreSfx.currentTime = 0; scoreSfx.play().catch(()=>{}); } catch(e){}
                items.splice(i, 1); bullets.splice(j, 1);
                updateUI();
            }
        });
        if (items[i] && invincibility <= 0) {
            if (oscar.x + 40 < it.x + it.size - 40 && oscar.x + oscar.w - 40 > it.x + 40 && oscar.y + 40 < it.y + it.size - 40 && oscar.y + oscar.h - 40 > it.y + 40) {
                lives--; invincibility = 100; items.splice(i, 1); updateUI();
                if (lives <= 0) { gameState = 'FAIL'; document.getElementById('failMsg').style.display = 'block'; }
            }
        }
        if (it && it.x + it.size < 0) items.splice(i, 1);
    }
    
    let target = currentStage * 1000;
    if (score >= target) { 
        gameState = 'SUCCESS'; 
        document.getElementById('successMsg').style.display = 'block'; 
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (images.bg.complete) ctx.drawImage(images.bg, 0, 0, canvas.width, canvas.height);
    
    // Only draw game elements if PLAYING (Hides Oscar/Items during Stage 10 Win)
    if (gameState === 'PLAYING' || gameState === 'SUCCESS' || gameState === 'FAIL') {
        if (invincibility % 10 < 5) ctx.drawImage(images.oscar, oscar.x, oscar.y, oscar.w, oscar.h);
        bullets.forEach(b => { ctx.fillStyle = '#00f2ff'; ctx.fillRect(b.x, b.y, b.w, b.h); });
        items.forEach(it => {
            let img = images.box;
            if(it.type === 'bonus') img = images.ramen;
            if(it.type === 'super') img = images.meat;
            ctx.drawImage(img, it.x, it.y, it.size, it.size);
        });
    }
}

function nextStage() { 
    initStage(currentStage + 1); 
}

function restartGame() {
    // Show UI elements again for Stage 1
    document.getElementById('ui').style.display = 'block';
    document.getElementById('mobileControls').style.display = 'block';
    document.getElementById('stage-bar').style.display = 'flex';
    initStage(1);
}

function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
gameLoop();
</script>
</body>
</html>